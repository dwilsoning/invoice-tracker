<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sage - Finance Specialist</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #chatContainer {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    #header {
      padding: 20px 24px;
      background: linear-gradient(135deg, #393392 0%, #2d2870 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #headerLeft {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    #avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #00BBBA;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      color: #151744;
    }

    #headerTitle h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    #headerTitle p {
      margin: 4px 0 0 0;
      font-size: 13px;
      opacity: 0.95;
      font-weight: 400;
    }

    #clearButton {
      padding: 8px 16px;
      background-color: #151744;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    #clearButton:hover {
      background-color: #0d0e2a;
      transform: translateY(-1px);
    }

    #messagesContainer {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: linear-gradient(to bottom, #f8f9fa, #ffffff);
    }

    .message {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }

    .message.user {
      align-items: flex-end;
    }

    .message.assistant {
      align-items: flex-start;
    }

    .messageContent {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.6;
    }

    .message.user .messageContent {
      background-color: #393392;
      color: white;
    }

    .message.assistant .messageContent {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #e0e0e0;
    }

    .timestamp {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 4px;
    }

    #loadingIndicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px;
      color: #666;
    }

    #loadingIndicator.active {
      display: flex;
    }

    .loadingDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #393392;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loadingDot:nth-child(1) { animation-delay: -0.32s; }
    .loadingDot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    #inputContainer {
      padding: 20px 24px;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }

    #messageInput {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s;
      outline: none;
      resize: none;
      min-height: 52px;
      max-height: 140px;
      overflow-y: auto;
      line-height: 1.5;
    }

    #messageInput:focus {
      border-color: #393392;
      box-shadow: 0 0 0 3px rgba(57, 51, 146, 0.1);
    }

    #sendButton {
      padding: 14px 28px;
      background-color: #393392;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    #sendButton:hover {
      background-color: #2d2870;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(57, 51, 146, 0.3);
    }

    #sendButton:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    #suggestedQuestions {
      padding: 0 24px 16px 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .suggestedQuestion {
      padding: 8px 14px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestedQuestion:hover {
      background-color: #393392;
      color: white;
      border-color: #393392;
      transform: translateY(-1px);
    }

    #errorMessage {
      display: none;
      padding: 12px 18px;
      margin: 0 24px 16px 24px;
      background-color: #fee;
      color: #c33;
      border-radius: 8px;
      font-size: 14px;
      border: 1px solid #fcc;
    }

    #errorMessage.active {
      display: block;
    }
  </style>
</head>
<body>
  <div id="chatContainer">
    <!-- Header -->
    <div id="header">
      <div id="headerLeft">
        <div id="avatar">S</div>
        <div id="headerTitle">
          <h1>Sage</h1>
          <p>Finance Specialist • Invoice Analytics Expert</p>
        </div>
      </div>
      <button id="clearButton">Clear Chat</button>
    </div>

    <!-- Messages -->
    <div id="messagesContainer"></div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator">
      <div class="loadingDot"></div>
      <div class="loadingDot"></div>
      <div class="loadingDot"></div>
      <span>Sage is thinking...</span>
    </div>

    <!-- Error Message -->
    <div id="errorMessage"></div>

    <!-- Suggested Questions -->
    <div id="suggestedQuestions">
      <div class="suggestedQuestion">What is my current DSO?</div>
      <div class="suggestedQuestion">Show me the aging analysis</div>
      <div class="suggestedQuestion">Which clients are high risk?</div>
      <div class="suggestedQuestion">What's my cash flow for next 30 days?</div>
    </div>

    <!-- Input -->
    <div id="inputContainer">
      <textarea id="messageInput" placeholder="Ask Sage about your invoices..." rows="1"></textarea>
      <button id="sendButton">Send</button>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3001/api';
    let messages = [];
    let isLoading = false;
    let token = null;

    // Get token from URL parameters or localStorage
    function getAuthToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get('token');
      if (urlToken) {
        localStorage.setItem('sage_auth_token', urlToken);
        return urlToken;
      }
      return localStorage.getItem('sage_auth_token');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      token = getAuthToken();
      if (!token) {
        showError('Authentication required. Please open Sage from the main application.');
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendButton').disabled = true;
        return;
      }

      // Add welcome message
      addMessage('assistant', 'Hello! I\'m Sage, your expert Finance Specialist for the Altera APAC Invoice Tracker.\n\nI specialise in invoice management, accounts receivable analytics, and aged debt recovery. I have access to your real-time analytics including:\n\n• DSO and aging analysis\n• Cash flow projections\n• Payment velocity and trends\n• Risk metrics and alerts\n• Client payment patterns\n\nI\'ll provide clear insights, actionable recommendations, and proactive alerts to help you optimise your accounts receivable. How can I assist you today?');

      // Event listeners
      const messageInput = document.getElementById('messageInput');

      document.getElementById('sendButton').addEventListener('click', sendMessage);

      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-expand textarea as user types
      messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 140) + 'px';
      });

      document.getElementById('clearButton').addEventListener('click', clearChat);

      // Suggested questions
      document.querySelectorAll('.suggestedQuestion').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('messageInput').value = btn.textContent;
          sendMessage();
        });
      });

      // Focus input
      document.getElementById('messageInput').focus();
    });

    function addMessage(role, content) {
      const timestamp = new Date().toISOString();
      messages.push({ role, content, timestamp });

      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'messageContent';
      contentDiv.textContent = content;

      const timestampDiv = document.createElement('div');
      timestampDiv.className = 'timestamp';
      timestampDiv.textContent = new Date(timestamp).toLocaleTimeString();

      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(timestampDiv);
      container.appendChild(messageDiv);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message || isLoading) return;

      // Add user message
      addMessage('user', message);
      input.value = '';
      input.style.height = 'auto';

      // Show loading
      isLoading = true;
      document.getElementById('loadingIndicator').classList.add('active');
      document.getElementById('sendButton').disabled = true;
      hideError();

      try {
        // Prepare chat history
        const chatHistory = messages
          .filter(msg => msg.role !== 'system')
          .map(msg => ({
            role: msg.role,
            content: msg.role === 'assistant'
              ? [{ type: 'output_text', text: msg.content }]
              : msg.content
          }));

        // Send to backend
        const response = await fetch(`${API_URL}/chatbot/query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            message,
            chatHistory
          })
        });

        const data = await response.json();

        if (data.success) {
          addMessage('assistant', data.message);
        } else {
          throw new Error(data.error || 'Failed to get response');
        }
      } catch (err) {
        console.error('Chatbot error:', err);
        showError(err.message || 'Failed to send message. Please try again.');
        addMessage('assistant', 'I apologize, but I encountered an error processing your request. Please try again.');
      } finally {
        isLoading = false;
        document.getElementById('loadingIndicator').classList.remove('active');
        document.getElementById('sendButton').disabled = false;
        input.focus();
      }
    }

    function clearChat() {
      messages = [];
      document.getElementById('messagesContainer').innerHTML = '';
      addMessage('assistant', 'Chat cleared. How can I assist you?');
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('active');
    }

    function hideError() {
      document.getElementById('errorMessage').classList.remove('active');
    }
  </script>
</body>
</html>
